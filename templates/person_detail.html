{% extends "base.html" %}

{% block title %}{{ person.name }} - Executive Profile{% endblock %}

{% block content %}
    <section class="profile-header">
        <div class="profile-avatar">
            {{ person.name.split()[0][0] }}{{ person.name.split()[-1][0] if person.name.split()|length > 1 else '' }}
        </div>
        <div class="profile-primary">
            <h1>{{ person.name }}</h1>
            <p class="profile-title">{{ person.current_title or 'Role not available' }}</p>
            <div class="profile-tags">
                {% if person.is_executive %}
                    <span class="profile-tag profile-tag--exec">Executive</span>
                {% endif %}
                {% if person.is_director %}
                    <span class="profile-tag profile-tag--board">Director</span>
                {% endif %}
                {% if selected_year != 'career' %}
                    <span class="profile-tag">Season {{ selected_year }}</span>
                {% else %}
                    <span class="profile-tag">Career View</span>
                {% endif %}
            </div>
            {% if person.bio_short %}
                <p class="profile-bio">{{ person.bio_short }}</p>
            {% endif %}
        </div>
        <div class="profile-links">
            {% if person.linkedin_url %}
                <a class="profile-link" href="{{ person.linkedin_url }}" target="_blank" rel="noopener">
                    LinkedIn Profile
                </a>
            {% endif %}
        </div>
    </section>

    <section class="profile-meta-grid">
        <div class="profile-meta">
            <span class="meta-label">Status</span>
            <span class="meta-value">{{ person.status or '‚Äî' }}</span>
        </div>
        <div class="profile-meta">
            <span class="meta-label">Years of Experience</span>
            <span class="meta-value">{{ person.years_experience or '‚Äî' }}</span>
        </div>
        <div class="profile-meta">
            <span class="meta-label">Education</span>
            <span class="meta-value">{{ person.education or '‚Äî' }}</span>
        </div>
    </section>

    <section class="profile-stats-grid">
        <div class="stat-card">
            <span class="stat-title">Career Earnings</span>
            <span class="stat-value">${{ "{:,.0f}".format(career_stats.total_earnings) }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-title">Years Active</span>
            <span class="stat-value">{{ career_stats.years_active }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-title">Companies</span>
            <span class="stat-value">{{ career_stats.companies_count }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-title">Avg Annual</span>
            <span class="stat-value">${{ "{:,.0f}".format(career_stats.avg_annual) }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-title">Career High</span>
            <span class="stat-value">${{ "{:,.0f}".format(career_stats.highest_single_year) }}</span>
        </div>
    </section>

    <section class="team-card chart-card profile-chart-card">
        <header class="team-card-header">
            <span class="icon">&#128200;</span>
            <div>
                <h3>Compensation Trend</h3>
                <p>Salary, stock, and total compensation across disclosed years</p>
            </div>
        </header>
        <div class="chart-shell chart-shell--compact">
            <canvas id="personCompChart"></canvas>
        </div>
    </section>

    <!-- Contract History & Current Deals -->
    <section class="team-card">
        <header class="team-card-header">
            <span class="icon">&#128188;</span>
            <div>
                <h3>Contract History & Compensation Details</h3>
                <p>Latest proxy disclosures for {{ person.name }}</p>
            </div>
        </header>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Position</th>
                        <th>Type</th>
                        <th>Year</th>
                        <th>Contract Length</th>
                        <th>Base Salary</th>
                        <th>Bonus</th>
                        <th>Stock Awards</th>
                        <th>Signing Bonus</th>
                        <th>Total Compensation</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role in roles %}
                    <tr>
                        <td>
                            <a href="{{ url_for('company_detail', company_id=role.company_id) }}">
                                <strong>{{ role.company_name }}</strong><br>
                                <small class="muted-small">{{ role.company_ticker }}</small>
                            </a>
                        </td>
                        <td>{{ role.title }}</td>
                        <td>
                            <span class="position-badge {% if role.position_type == 'Board' %}board-badge{% endif %}">
                                {{ role.position_type }}
                            </span>
                        </td>
                        <td>{{ role.year }}</td>
                        <td>
                            <small class="muted-small">
                                {{ role.contract_years }} years
                            </small>
                        </td>
                        <td class="salary-amount">${{ "{:,.0f}".format(role.base_salary) }}</td>
                        <td class="salary-amount">
                            {% if role.bonus > 0 %}
                                ${{ "{:,.0f}".format(role.bonus) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="cap-hit">${{ "{:,.0f}".format(role.stock_awards) }}</td>
                        <td class="salary-amount">
                            {% if role.signing_bonus > 0 %}
                                ${{ "{:,.0f}".format(role.signing_bonus) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="salary-amount"><strong>${{ "{:,.0f}".format(role.total_compensation) }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <section class="profile-dual-panels">
        <div class="team-card">
            <h3 class="accent-title" style="margin-top: 0;">üìä Compensation Makeup</h3>
            <div class="profile-breakdown">
                {% set total_base = roles|sum(attribute='base_salary') %}
                {% set total_bonus = roles|sum(attribute='bonus') %}
                {% set total_stock = roles|sum(attribute='stock_awards') %}
                {% set total_signing = roles|sum(attribute='signing_bonus') %}
                {% set total_earnings = career_stats.total_earnings %}
                {% set divisor = total_earnings if total_earnings else 1 %}

                <div class="profile-breakdown-row">
                    <span>Base Salary</span>
                    <span class="salary-amount">
                        ${{ "{:,.0f}".format(total_base) }}
                        {% if total_earnings %}
                            <small class="muted-small">({{ "{:.1f}".format((total_base / divisor) * 100) }}%)</small>
                        {% endif %}
                    </span>
                </div>
                <div class="profile-breakdown-row">
                    <span>Performance Bonus</span>
                    <span class="salary-amount">
                        ${{ "{:,.0f}".format(total_bonus) }}
                        {% if total_earnings %}
                            <small class="muted-small">({{ "{:.1f}".format((total_bonus / divisor) * 100) }}%)</small>
                        {% endif %}
                    </span>
                </div>
                <div class="profile-breakdown-row">
                    <span>Stock Awards</span>
                    <span class="cap-hit">
                        ${{ "{:,.0f}".format(total_stock) }}
                        {% if total_earnings %}
                            <small class="muted-small">({{ "{:.1f}".format((total_stock / divisor) * 100) }}%)</small>
                        {% endif %}
                    </span>
                </div>
                <div class="profile-breakdown-row">
                    <span>Signing Bonuses</span>
                    <span class="salary-amount">
                        ${{ "{:,.0f}".format(total_signing) }}
                        {% if total_earnings %}
                            <small class="muted-small">({{ "{:.1f}".format((total_signing / divisor) * 100) }}%)</small>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <div class="team-card">
            <h3 class="warning-title" style="margin-top: 0;">üèÜ Career Highlights</h3>
            <div class="profile-breakdown">
                <div class="profile-breakdown-row">
                    <span>Best Single Year</span>
                    <span class="salary-amount">${{ "{:,.0f}".format(career_stats.highest_single_year) }}</span>
                </div>
                <div class="profile-breakdown-row">
                    <span>Companies Worked For</span>
                    <span class="cap-hit">{{ career_stats.companies_count }} teams</span>
                </div>
                <div class="profile-breakdown-row">
                    <span>Current Status</span>
                    <span class="{% if (person.status or '').lower() == 'active' %}salary-amount{% else %}cap-hit{% endif %}">
                        {{ person.status or '‚Äî' }}
                    </span>
                </div>
                <div class="profile-breakdown-row">
                    <span>Years of Experience</span>
                    <span class="cap-hit">{{ person.years_experience or '‚Äî' }}</span>
                </div>
            </div>
        </div>
    </section>

    <script>
        const compHistory = {{ compensation_history_chart|tojson }};
        const compChartCanvas = document.getElementById('personCompChart');
        if (compChartCanvas && compHistory.labels.length) {
            new Chart(compChartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: compHistory.labels,
                    datasets: [
                        {
                            label: 'Total Compensation',
                            data: compHistory.total,
                            borderColor: 'rgba(244, 63, 94, 1)',
                            backgroundColor: 'rgba(244, 63, 94, 0.2)',
                            borderWidth: 2,
                            tension: 0.35,
                            fill: true
                        },
                        {
                            label: 'Stock Awards',
                            data: compHistory.stock,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.18)',
                            borderWidth: 1.6,
                            tension: 0.35,
                            fill: false
                        },
                        {
                            label: 'Salary',
                            data: compHistory.salary,
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.15)',
                            borderWidth: 1.6,
                            tension: 0.35,
                            fill: false
                        },
                        {
                            label: 'Bonus',
                            data: compHistory.bonus,
                            borderColor: 'rgba(250, 204, 21, 1)',
                            backgroundColor: 'rgba(250, 204, 21, 0.15)',
                            borderWidth: 1.3,
                            tension: 0.35,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5f5' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#94a3b8',
                                callback: (value) => '$' + value.toLocaleString()
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }
    </script>
{% endblock %}
