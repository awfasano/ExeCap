{% extends "base.html" %}

{% block title %}League Dashboard | ExecuCap{% endblock %}

{% block content %}
    <section class="hero-card">
        <div class="hero-headline">
            <div>
                <p class="hero-eyebrow">Executive Salary Cap League</p>
                <h1>Front Office Finance Dashboard</h1>
                <p class="hero-subcopy">
                    Benchmark executive payrolls, boardroom spend, and insider ownership across the league.
                </p>
            </div>
            <form class="season-switcher" method="get">
                <label for="season-select">Season</label>
                <select id="season-select" name="year" onchange="this.form.submit()">
                    {% for year in available_years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                            {{ year }}
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="hero-stats">
            <div class="hero-stat">
                <span class="stat-label">Teams Tracked</span>
                <span class="stat-value">{{ summary_metrics.companies }}</span>
            </div>
            <div class="hero-stat">
                <span class="stat-label">Executive Payroll</span>
                <span class="stat-value">${{ "{:,.0f}".format(summary_metrics.total_exec_spend) }}</span>
            </div>
            <div class="hero-stat">
                <span class="stat-label">Director Payroll</span>
                <span class="stat-value">${{ "{:,.0f}".format(summary_metrics.total_director_spend) }}</span>
            </div>
            <div class="hero-stat">
                <span class="stat-label">Insider Shares (Exec)</span>
                <span class="stat-value">{{ "{:,.0f}".format(summary_metrics.total_exec_shares) }}</span>
            </div>
            <div class="hero-stat">
                <span class="stat-label">Insider Shares (Board)</span>
                <span class="stat-value">{{ "{:,.0f}".format(summary_metrics.total_director_shares) }}</span>
            </div>
        </div>
    </section>

    <div class="home-grid">
        <section class="dashboard-card dashboard-card--wide">
            <h2>Compensation Pulse</h2>
            <p class="muted-text">Benchmark spend, headcount, and insider pressure</p>
            <div class="chart-tabs">
                <button class="chart-tab active" data-chart="execPayroll">Exec Payroll</button>
                <button class="chart-tab" data-chart="directorPayroll">Director Payroll</button>
                <button class="chart-tab" data-chart="execHeadcount">Exec Headcount</button>
                <button class="chart-tab" data-chart="ownershipDensity">Insider Shares</button>
            </div>
            <div class="chart-layout">
                <div class="chart-shell">
                    <canvas id="mainBarChart"></canvas>
                </div>
                <div class="chart-side">
                    <div class="chart-side-card">
                        <h3 class="chart-side-title">Payroll Mix</h3>
                        <canvas id="payMixChart"></canvas>
                    </div>
                    <div class="chart-side-card">
                        <h3 class="chart-side-title">Insider Share Mix</h3>
                        <canvas id="ownershipMixChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="dashboard-card dashboard-card--wide">
            <h2>Company Salary Cap Table</h2>
            <p class="muted-text">Sorted by executive compensation for {{ selected_year }}</p>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Company</th>
                            <th>Exec Spend</th>
                            <th>Director Spend</th>
                            <th>Avg Exec Exp.</th>
                            <th>Execs</th>
                            <th>Directors</th>
                            <th>Director Shares</th>
                            <th>Executive Shares</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in company_rows %}
                        <tr>
                            <td>{{ row.rank }}</td>
                            <td>
                                <a href="{{ url_for('company_detail', company_id=row.company.company_id) }}">
                                    <strong>{{ row.company.name }}</strong><br>
                                    <small class="muted-small">{{ row.company.ticker }}</small>
                                </a>
                            </td>
                            <td class="salary-amount">${{ "{:,.0f}".format(row.executive_total) }}</td>
                            <td class="salary-amount">${{ "{:,.0f}".format(row.director_total) }}</td>
                            <td>
                                {% if row.avg_experience %}
                                    {{ "{:.1f}".format(row.avg_experience) }} yrs
                                {% else %}
                                    n/a
                                {% endif %}
                            </td>
                            <td>{{ row.executive_count }}</td>
                            <td>{{ row.director_count }}</td>
                            <td>{{ "{:,.0f}".format(row.ownership_director_shares) }}</td>
                            <td>{{ "{:,.0f}".format(row.ownership_exec_shares) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="top-lists">
            <h2>Front Office Spotlight</h2>
            <div class="top-lists-grid">
                <div class="top-list-card">
                    <h3>Highest Paid Executives</h3>
                    <ul class="top-list">
                        {% for exec in top_paid_execs %}
                        <li>
                            <a href="{{ url_for('person_detail', person_id=exec.person_id) }}">{{ exec.person_name }}</a>
                            <span class="top-list-meta">{{ exec.company_ticker }} &#8226; {{ exec.title }}</span>
                            <span class="top-list-value">${{ "{:,.0f}".format(exec.total_compensation) }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="top-list-card">
                    <h3>Top Executive Shareholders</h3>
                    <ul class="top-list">
                        {% for owner in top_exec_owners %}
                        <li>
                            <a href="{{ url_for('person_detail', person_id=owner.person_id) }}">{{ owner.person_name }}</a>
                            <span class="top-list-meta">{{ owner.company_ticker }} &#8226; {{ owner.company_name }}</span>
                            <span class="top-list-value">{{ "{:,.0f}".format(owner.total_shares) }} sh</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="top-list-card">
                    <h3>Top Director Shareholders</h3>
                    <ul class="top-list">
                        {% for owner in top_director_owners %}
                        <li>
                            <span>{{ owner.person_name }}</span>
                            <span class="top-list-meta">{{ owner.company_ticker }} &#8226; {{ owner.company_name }}</span>
                            <span class="top-list-value">{{ "{:,.0f}".format(owner.total_shares) }} sh</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </section>
    </div>

    <script>
        const execLabels = {{ exec_chart_labels|tojson }};
        const execValues = {{ exec_chart_values|tojson }};
        const execDistribution = {{ exec_distribution|tojson }};
        const directorSpendChart = {{ director_spend_chart|tojson }};
        const ownershipDensity = {{ ownership_density|tojson }};
        const payMixChartData = {{ pay_mix_chart|tojson }};
        const ownershipMixChartData = {{ ownership_mix_chart|tojson }};

        const mainCtx = document.getElementById('mainBarChart');
        const payMixCtx = document.getElementById('payMixChart');
        const ownershipMixCtx = document.getElementById('ownershipMixChart');

        const formatCurrency = (value) => '$' + new Intl.NumberFormat().format(Math.round(value));
        const formatNumber = (value) => new Intl.NumberFormat().format(Math.round(value));
        const formatShares = (value) => formatNumber(value) + ' sh';

        const chartConfigs = {
            execPayroll: {
                type: 'bar',
                label: 'Executive Payroll (USD)',
                labels: execLabels,
                values: execValues,
                background: 'rgba(244, 63, 94, 0.75)',
                border: 'rgba(244, 63, 94, 1)',
                tickFormatter: formatCurrency,
                tooltipFormatter: formatCurrency
            },
            directorPayroll: {
                type: 'bar',
                label: 'Director Payroll (USD)',
                labels: directorSpendChart.labels,
                values: directorSpendChart.values,
                background: 'rgba(59, 130, 246, 0.75)',
                border: 'rgba(59, 130, 246, 1)',
                tickFormatter: formatCurrency,
                tooltipFormatter: formatCurrency
            },
            execHeadcount: {
                type: 'bar',
                label: 'Executive Headcount',
                labels: execDistribution.labels,
                values: execDistribution.values,
                background: 'rgba(56, 189, 248, 0.75)',
                border: 'rgba(56, 189, 248, 1)',
                tickFormatter: formatNumber,
                tooltipFormatter: (value) => formatNumber(value) + ' execs'
            },
            ownershipDensity: {
                type: 'bar',
                label: 'Insider Shares (Directors + Execs)',
                labels: ownershipDensity.labels,
                values: ownershipDensity.values,
                background: 'rgba(250, 204, 21, 0.75)',
                border: 'rgba(250, 204, 21, 1)',
                tickFormatter: formatShares,
                tooltipFormatter: formatShares
            }
        };

        const getBarOptions = (config) => ({
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => config.tooltipFormatter(ctx.parsed.y ?? ctx.parsed)
                    }
                }
            },
            scales: {
                x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#94a3b8',
                        callback: (value) => config.tickFormatter(value)
                    },
                    grid: { color: 'rgba(148, 163, 184, 0.15)' }
                }
            }
        });

        const getStackedBarOptions = (formatter) => ({
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#94a3b8', boxWidth: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: ${formatter(ctx.parsed.x)}`
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    ticks: {
                        color: '#94a3b8',
                        callback: (value) => formatter(value)
                    },
                    grid: { color: 'rgba(148, 163, 184, 0.15)' }
                },
                y: {
                    stacked: true,
                    ticks: { color: '#94a3b8' },
                    grid: { display: false }
                }
            }
        });

        let activeConfig = chartConfigs.execPayroll;
        const mainChart = new Chart(mainCtx, {
            type: activeConfig.type,
            data: {
                labels: activeConfig.labels,
                datasets: [{
                    label: activeConfig.label,
                    data: activeConfig.values,
                    backgroundColor: activeConfig.background,
                    borderColor: activeConfig.border,
                    borderWidth: 2,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: getBarOptions(activeConfig)
        });

        const updateMainChart = (key) => {
            const config = chartConfigs[key];
            activeConfig = config;
            mainChart.config.type = config.type;
            mainChart.data.labels = config.labels;
            mainChart.data.datasets[0].label = config.label;
            mainChart.data.datasets[0].data = config.values;
            mainChart.data.datasets[0].backgroundColor = config.background;
            mainChart.data.datasets[0].borderColor = config.border;
            mainChart.options = getBarOptions(config);
            mainChart.update();
        };

        if (payMixCtx) {
            new Chart(payMixCtx, {
                type: 'bar',
                data: {
                    labels: payMixChartData.labels,
                    datasets: [
                        {
                            label: 'Exec Payroll',
                            data: payMixChartData.executive,
                            backgroundColor: 'rgba(244, 63, 94, 0.8)',
                            borderColor: 'rgba(244, 63, 94, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        },
                        {
                            label: 'Director Payroll',
                            data: payMixChartData.director,
                            backgroundColor: 'rgba(59, 130, 246, 0.75)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }
                    ]
                },
                options: getStackedBarOptions(formatCurrency)
            });
        }

        if (ownershipMixCtx) {
            new Chart(ownershipMixCtx, {
                type: 'bar',
                data: {
                    labels: ownershipMixChartData.labels,
                    datasets: [
                        {
                            label: 'Exec Shares',
                            data: ownershipMixChartData.exec_shares,
                            backgroundColor: 'rgba(14, 165, 233, 0.75)',
                            borderColor: 'rgba(14, 165, 233, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        },
                        {
                            label: 'Director Shares',
                            data: ownershipMixChartData.director_shares,
                            backgroundColor: 'rgba(251, 146, 60, 0.78)',
                            borderColor: 'rgba(251, 146, 60, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }
                    ]
                },
                options: getStackedBarOptions(formatShares)
            });
        }

        document.querySelectorAll('.chart-tab').forEach((btn) => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.chart-tab').forEach((b) => b.classList.remove('active'));
                btn.classList.add('active');
                updateMainChart(btn.dataset.chart);
            });
        });
    </script>
{% endblock %}
