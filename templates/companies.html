{% extends "base.html" %}

{% block title %}Team Salary Caps | Executive Compensation League{% endblock %}

{% block content %}
    <h1>üí∞ Team Salary Cap Situations</h1>
    <p>Executive compensation budget utilization across all teams in the league</p>

    {% if companies %}
    <div class="stats-container">
        <div class="stat-card">
            <span class="stat-title">Teams Over Budget</span>
            <span class="stat-value" style="color: #ef4444;">
                {{ companies|selectattr('cap_info.utilization_pct', '>', 100)|list|length }}
            </span>
        </div>
        <div class="stat-card">
            <span class="stat-title">Avg Cap Utilization</span>
            <span class="stat-value">
                {% if companies|length > 0 %}
                    {{ "{:.1f}".format((companies|sum(attribute='cap_info.utilization_pct')) / companies|length) }}%
                {% else %}
                    0.0%
                {% endif %}
            </span>
        </div>
        <div class="stat-card">
            <span class="stat-title">Total League Spending</span>
            <span class="stat-value">
                ${{ "{:,.0f}".format(companies|sum(attribute='cap_info.total_spent')) }}
            </span>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Team</th>
                <th>Sector</th>
                <th>Market Cap</th>
                <th>Exec Budget</th>
                <th>Spent</th>
                <th>Cap Space</th>
                <th>Utilization</th>
                <th>Roster</th>
            </tr>
        </thead>
        <tbody>
            {% for company in companies %}
            <tr>
                <td>
                    <a href="{{ url_for('company_detail', company_id=company.id) }}">
                        <strong>{{ company.name }}</strong><br>
                        <small style="color: #94a3b8;">{{ company.ticker }}</small>
                    </a>
                </td>
                <td>{{ company.sector }}</td>
                <td class="salary-amount">${{ "{:,.0f}".format(company.market_cap / 1000000) }}M</td>
                <td class="salary-amount">${{ "{:,.0f}".format(company.cap_info.budget) }}</td>
                <td class="salary-amount">${{ "{:,.0f}".format(company.cap_info.total_spent) }}</td>
                <td class="{% if company.cap_info.remaining < 0 %}salary-amount{% else %}cap-hit{% endif %}">
                    {% if company.cap_info.remaining < 0 %}
                        -${{ "{:,.0f}".format(abs(company.cap_info.remaining)) }}
                    {% else %}
                        ${{ "{:,.0f}".format(company.cap_info.remaining) }}
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div class="cap-bar" style="width: 60px; height: 6px; margin: 0;">
                            <div class="cap-fill {% if company.cap_info.utilization_pct > 100 %}over-budget{% endif %}"
                                 style="width: {{ [company.cap_info.utilization_pct, 100]|min }}%"></div>
                        </div>
                        <span class="{% if company.cap_info.utilization_pct > 100 %}salary-amount{% else %}cap-hit{% endif %}">
                            {{ "{:.1f}".format(company.cap_info.utilization_pct) }}%
                        </span>
                    </div>
                </td>
                <td>
                    <div style="font-size: 0.9rem;">
                        <span class="position-badge">{{ company.c_suite_count }}</span> C-Suite<br>
                        <span class="position-badge board-badge">{{ company.board_count }}</span> Board
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 3rem; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; border: 1px solid #475569; margin-top: 2rem;">
        <h3 style="color: #f59e0b; margin-bottom: 1rem;">‚ö†Ô∏è No Data Available</h3>
        <p style="color: #94a3b8; margin: 0 0 1.5rem 0;">
            No company data found for the selected year. This could mean:
        </p>
        <ul style="text-align: left; display: inline-block; color: #94a3b8;">
            <li>No Excel files uploaded to the GCS bucket yet</li>
            <li>Files are not in the correct folder structure (companies/company_name/year/)</li>
            <li>The selected year has no data</li>
        </ul>
        <p style="margin-top: 2rem;">
            <a href="{{ url_for('refresh_data') }}" class="button-link" style="display: inline-block;">
                üîÑ Refresh Data
            </a>
        </p>
    </div>
    {% endif %}

    {% if companies %}
    <div style="margin-top: 2rem; padding: 1rem; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 8px; border: 1px solid #475569;">
        <h3 style="color: #10b981; margin-top: 0;">üí° Cap Space Explanation</h3>
        <p style="color: #94a3b8; margin-bottom: 0;">
            <strong>Executive Budget:</strong> Each company's allocated budget for C-Suite and Board compensation.<br>
            <strong>Cap Space:</strong> Remaining budget available for new hires or raises.<br>
            <strong>Utilization:</strong> Percentage of budget currently being used. Teams over 100% are exceeding their planned budget.
        </p>
    </div>
    {% endif %}
{% endblock %}