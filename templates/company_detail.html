{% extends "base.html" %}

{% block title %}{{ company.name }} - Front Office Ledger{% endblock %}

{% block content %}
    <section class="team-banner">
        <div class="team-identity">
            <div class="team-badge glitch" data-text="{{ company.ticker_display }}">
                <span>{{ company.ticker_display }}</span>
            </div>
            <div class="team-heading">
                <h1>{{ company.name }}</h1>
                <p class="team-subline">{{ company.ticker }} ‚Ä¢ {{ company.sector }} ‚Ä¢ Founded {{ company.founded }}</p>
                <div class="team-tags">
                    <span class="team-tag">Fiscal Year End {{ company.fiscal_year_end.strftime('%Y-%m-%d') }}</span>
                    {% if company.source_url %}
                        <span class="team-tag"><a href="{{ company.source_url }}" target="_blank">Proxy Source</a></span>
                    {% endif %}
                    {% if company.revenue %}
                        <span class="team-tag">Revenue ${{ "{:,.1f}".format(company.revenue / 1_000_000_000) }}B</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="team-statsbar">
            <div class="team-stat">
                <span class="team-stat-label">Budget Utilization</span>
                <span class="team-stat-value {% if cap_info.utilization_pct > 100 %}danger{% endif %}">{{ "{:.1f}".format(cap_info.utilization_pct) }}%</span>
            </div>
            <div class="team-stat">
                <span class="team-stat-label">Cap Remaining</span>
                <span class="team-stat-value {% if cap_info.remaining < 0 %}danger{% endif %}">
                    {% if cap_info.remaining < 0 %}
                        -${{ "{:,.0f}".format(abs(cap_info.remaining)) }}
                    {% else %}
                        ${{ "{:,.0f}".format(cap_info.remaining) }}
                    {% endif %}
                </span>
            </div>
            <div class="team-stat">
                <span class="team-stat-label">Exec Payroll</span>
                <span class="team-stat-value">${{ "{:,.0f}".format(company_summary.exec_total) }}</span>
            </div>
            <div class="team-stat">
                <span class="team-stat-label">Directors Payroll</span>
                <span class="team-stat-value">${{ "{:,.0f}".format(company_summary.director_total) }}</span>
            </div>
        </div>
    </section>

    <section class="team-grid">
        <div class="team-card large">
            <header class="team-card-header">
                <span class="icon">üßÆ</span>
                <div>
                    <h3>Executive Ledger</h3>
                    <p>Compensation outlay for named executive officers</p>
                </div>
            </header>
            <ul class="stat-list">
                <li><span>Executive Payroll</span><strong>${{ "{:,.0f}".format(company_summary.exec_total) }}</strong></li>
                <li><span>Average Exec Compensation</span><strong>${{ "{:,.0f}".format(company_summary.exec_avg_comp) }}</strong></li>
                <li><span>Average Exec Experience</span><strong>
                    {% if company_summary.exec_avg_experience %}
                        {{ "{:.1f}".format(company_summary.exec_avg_experience) }} yrs
                    {% else %}
                        ‚Äî
                    {% endif %}
                </strong></li>
                <li><span>Exec Count</span><strong>{{ company_summary.exec_count }}</strong></li>
            </ul>
        </div>

        <div class="team-card">
            <header class="team-card-header">
                <span class="icon">üèõÔ∏è</span>
                <div>
                    <h3>Board Stipend</h3>
                    <p>Non-employee director compensation</p>
                </div>
            </header>
            {% if director_comp_summary %}
            <ul class="stat-list">
                <li><span>Covered Directors</span><strong>{{ director_comp_summary.members }}</strong></li>
                <li><span>Avg Cash Retainer</span><strong>${{ "{:,.0f}".format(director_comp_summary.avg_cash) }}</strong></li>
                <li><span>Avg Stock Award</span><strong>${{ "{:,.0f}".format(director_comp_summary.avg_stock) }}</strong></li>
                <li><span>Avg Total Comp</span><strong>${{ "{:,.0f}".format(director_comp_summary.avg_total) }}</strong></li>
            </ul>
            {% else %}
            <p style="color:#94a3b8;">Director compensation data not available for this season.</p>
            {% endif %}
        </div>

        <div class="team-card">
            <header class="team-card-header">
                <span class="icon">üß¨</span>
                <div>
                    <h3>Ownership Stack</h3>
                    <p>Beneficial holdings disclosed in the proxy</p>
                </div>
            </header>
            <ul class="stat-list">
                <li><span>Director Shares</span><strong>{{ "{:,.0f}".format(ownership_summary.director_shares) }}</strong></li>
                <li><span>Executive Shares</span><strong>{{ "{:,.0f}".format(ownership_summary.exec_shares) }}</strong></li>
                <li><span>Combined Control</span><strong>{{ "{:,.0f}".format(ownership_summary.total_shares) }}</strong></li>
                <li><span>Record Date</span><strong>{{ ownership_summary.as_of }}</strong></li>
            </ul>
        </div>

        <div class="team-card">
            <header class="team-card-header">
                <span class="icon">üìä</span>
                <div>
                    <h3>Market Signals</h3>
                    <p>Financial context & cap pressure</p>
                </div>
            </header>
            <ul class="stat-list">
                <li><span>Market Cap</span>
                    <strong>
                        {% if company.market_cap %}
                            ${{ "{:,.1f}".format(company.market_cap / 1_000_000_000) }}B
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </strong>
                </li>
                <li><span>Revenue</span>
                    <strong>
                        {% if company.revenue %}
                            ${{ "{:,.1f}".format(company.revenue / 1_000_000_000) }}B
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </strong>
                </li>
                <li><span>Exec % of Revenue</span>
                    <strong>
                        {% if cap_info.exec_percent_revenue %}
                            {{ "{:.2f}".format(cap_info.exec_percent_revenue) }}%
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </strong>
                </li>
                <li><span>Cap Budget</span><strong>${{ "{:,.0f}".format(cap_info.budget) }}</strong></li>
            </ul>
        </div>
    </section>

    <section class="team-card full chart-card">
        <header class="team-card-header">
            <span class="icon">üìà</span>
            <div>
                <h3>Executive Compensation Breakdown</h3>
                <p>Total compensation by named executive officer</p>
            </div>
        </header>
        <div class="chart-shell">
            <canvas id="compensationChart"></canvas>
        </div>
    </section>

    <!-- C-Suite Roster -->
    {% if c_suite %}
    <div class="roster-section">
        <div class="position-header">
            üéØ C-Suite Executives ({{ c_suite|length }})
        </div>
        <table>
            <thead>
                <tr>
                    <th>Executive</th>
                    <th>Position</th>
                    <th>Age/Exp</th>
                    <th>Contract</th>
                    <th>Base Salary</th>
                    <th>Bonus</th>
                    <th>Stock Awards</th>
                    <th>Signing Bonus</th>
                    <th>Total Comp</th>
                    <th>Cap Hit %</th>
                </tr>
            </thead>
            <tbody>
                {% for exec in c_suite %}
                <tr>
                    <td>
                        <a href="{{ url_for('person_detail', person_id=exec.person_id) }}">
                            <strong>{{ exec.name }}</strong>
                        </a>
                    </td>
                    <td>{{ exec.title }}</td>
                    <td>
                        <small style="color: #94a3b8;">
                            {{ exec.age or '‚Äî' }}y ‚Ä¢ {{ exec.experience or '‚Äî' }}y exp
                        </small>
                    </td>
                    <td>
                        <small style="color: #94a3b8;">
                            {{ exec.contract_years }} years
                        </small>
                    </td>
                    <td class="salary-amount">${{ "{:,.0f}".format(exec.base_salary) }}</td>
                    <td class="salary-amount">${{ "{:,.0f}".format(exec.bonus) }}</td>
                    <td class="cap-hit">${{ "{:,.0f}".format(exec.stock_awards) }}</td>
                    <td class="salary-amount">
                        {% if exec.signing_bonus > 0 %}
                            ${{ "{:,.0f}".format(exec.signing_bonus) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="salary-amount"><strong>${{ "{:,.0f}".format(exec.total_compensation) }}</strong></td>
                    <td class="cap-hit">{{ "{:.1f}".format(exec.cap_hit_pct) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Board Members -->
    {% if board_members %}
    <div class="roster-section">
        <div class="position-header" style="background: linear-gradient(90deg, #3b82f6, #1d4ed8);">
            üèõÔ∏è Board of Directors ({{ board_members|length }})
        </div>
        <table>
            <thead>
                <tr>
                    <th>Board Member</th>
                    <th>Position</th>
                    <th>Age/Exp</th>
                    <th>Contract</th>
                    <th>Cash Fees</th>
                    <th>Stock Awards</th>
                    <th>Other</th>
                    <th>Total Comp</th>
                </tr>
            </thead>
            <tbody>
                {% for member in board_members %}
                <tr>
                    <td>
                        <a href="{{ url_for('person_detail', person_id=member.person_id) }}">
                            <strong>{{ member.name }}</strong>
                        </a>
                    </td>
                    <td>{{ member.title }}</td>
                    <td>
                        <small style="color: #94a3b8;">
                            {{ member.age or '‚Äî' }}y ‚Ä¢ {{ member.experience or '‚Äî' }}y exp
                        </small>
                    </td>
                    <td>
                        <small style="color: #94a3b8;">
                            {{ member.contract_years }} years
                        </small>
                    </td>
                    <td class="salary-amount">${{ "{:,.0f}".format(member.base_salary) }}</td>
                    <td class="cap-hit">${{ "{:,.0f}".format(member.stock_awards) }}</td>
                    <td class="cap-hit">${{ "{:,.0f}".format(member.signing_bonus) }}</td>
                    <td class="salary-amount"><strong>${{ "{:,.0f}".format(member.total_compensation) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if director_comp_summary %}
    <div class="team-card" style="margin-top: 2rem;">
        <h3 style="color: #f59e0b; margin-top: 0;">üèõÔ∏è Board Compensation Snapshot</h3>
        <div class="cap-stats">
            <div class="stat-item">
                <div class="stat-label">Directors Covered</div>
                <div class="stat-value">{{ director_comp_summary.members }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Avg Cash Retainer</div>
                <div class="stat-value">${{ "{:,.0f}".format(director_comp_summary.avg_cash) }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Avg Stock Award</div>
                <div class="stat-value">${{ "{:,.0f}".format(director_comp_summary.avg_stock) }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Avg Total Comp</div>
                <div class="stat-value">${{ "{:,.0f}".format(director_comp_summary.avg_total) }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if director_policies %}
    <div class="team-card" style="margin-top: 2rem;">
        <h3 style="color: #38bdf8; margin-top: 0;">üìù Director Compensation Policy</h3>
        <ul style="margin: 0; padding-left: 1.2rem; color: #cbd5f5;">
            {% for policy in director_policies %}
            <li style="margin-bottom: 0.5rem;">
                <strong>{{ policy.component }}</strong>
                {% if policy.amount_usd %}
                    ‚Äî ${{ "{:,.0f}".format(policy.amount_usd) }} {{ policy.unit or '' }}
                {% endif %}
                {% if policy.notes %}
                    <br><small style="color: #94a3b8;">{{ policy.notes }}</small>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <script>
        // Chart.js implementation for compensation visualization
        const ctx = document.getElementById('compensationChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: 'Total Compensation (USD)',
                    data: {{ chart_data|safe }},
                    backgroundColor: 'rgba(244, 63, 94, 0.78)',
                    borderColor: 'rgba(244, 63, 94, 1)',
                    borderWidth: 1.5,
                    borderRadius: 5,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#e2e8f0'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#e2e8f0',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return 'Total Compensation: $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#94a3b8',
                            callback: function(value) {
                                return '$' + (value / 1000000).toFixed(1) + 'M';
                            }
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    }
                }
            }
        });
    </script>
{% endblock %}
