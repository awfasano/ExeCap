{% extends "base.html" %}

{% block title %}{{ company.name }} - Front Office Ledger{% endblock %}

{% block content %}
    <section class="team-banner">
        <div class="team-identity">
            <div class="team-badge glitch" data-text="{{ company.ticker_display }}">
                <span>{{ company.ticker_display }}</span>
            </div>
            <div class="team-heading">
                <h1>{{ company.name }}</h1>
            <p class="team-subline">{{ company.ticker }} &#8226; {{ company.sector }} &#8226; Founded {{ company.founded }}</p>
                <div class="team-tags">
                    <span class="team-tag">Fiscal Year End {{ company.fiscal_year_end.strftime('%Y-%m-%d') }}</span>
                    {% if company.source_url %}
                        <span class="team-tag"><a href="{{ company.source_url }}" target="_blank">Proxy Source</a></span>
                    {% endif %}
                    {% if company.revenue %}
                        <span class="team-tag">Revenue ${{ "{:,.1f}".format(company.revenue / 1_000_000_000) }}B</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="team-statsbar">
            <div class="team-stat">
                <span class="team-stat-label">Budget Utilization</span>
                <span class="team-stat-value {% if cap_info.utilization_pct > 100 %}danger{% endif %}">{{ "{:.1f}".format(cap_info.utilization_pct) }}%</span>
            </div>
            <div class="team-stat">
                <span class="team-stat-label">Cap Remaining</span>
                <span class="team-stat-value {% if cap_info.remaining < 0 %}danger{% endif %}">
                    {% if cap_info.remaining < 0 %}
                        -${{ "{:,.0f}".format(abs(cap_info.remaining)) }}
                    {% else %}
                        ${{ "{:,.0f}".format(cap_info.remaining) }}
                    {% endif %}
                </span>
            </div>
            <div class="team-stat">
                <span class="team-stat-label">Exec Payroll</span>
                <span class="team-stat-value">${{ "{:,.0f}".format(company_summary.exec_total) }}</span>
            </div>
            <div class="team-stat">
                <span class="team-stat-label">Directors Payroll</span>
                <span class="team-stat-value">${{ "{:,.0f}".format(company_summary.director_total) }}</span>
            </div>
        </div>
    </section>

    <section class="team-grid">
        <div class="team-card large">
            <header class="team-card-header">
                <span class="icon">&#129462;</span>
                <div>
                    <h3>Executive Ledger</h3>
                    <p>Compensation outlay for named executive officers</p>
                </div>
            </header>
            <ul class="stat-list">
                <li><span>Executive Payroll</span><strong>${{ "{:,.0f}".format(company_summary.exec_total) }}</strong></li>
                <li><span>Average Exec Compensation</span><strong>${{ "{:,.0f}".format(company_summary.exec_avg_comp) }}</strong></li>
                <li><span>Average Exec Experience</span><strong>
                    {% if company_summary.exec_avg_experience %}
                        {{ "{:.1f}".format(company_summary.exec_avg_experience) }} yrs
                    {% else %}
                        n/a
                    {% endif %}
                </strong></li>
            <li><span>Exec Count</span><strong>{{ company_summary.exec_count }}</strong></li>
            </ul>
        </div>

        <div class="team-card">
            <header class="team-card-header">
                <span class="icon">&#127974;</span>
                <div>
                    <h3>Board Stipend</h3>
                    <p>Non-employee director compensation</p>
                </div>
            </header>
            {% if director_comp_summary %}
            <ul class="stat-list">
                <li><span>Covered Directors</span><strong>{{ director_comp_summary.members }}</strong></li>
                <li><span>Avg Cash Retainer</span><strong>${{ "{:,.0f}".format(director_comp_summary.avg_cash) }}</strong></li>
                <li><span>Avg Stock Award</span><strong>${{ "{:,.0f}".format(director_comp_summary.avg_stock) }}</strong></li>
                <li><span>Avg Total Comp</span><strong>${{ "{:,.0f}".format(director_comp_summary.avg_total) }}</strong></li>
            </ul>
            {% else %}
            <p class="muted-text">Director compensation data not available for this season.</p>
            {% endif %}
        </div>

        <div class="team-card">
            <header class="team-card-header">
                <span class="icon">&#129516;</span>
                <div>
                    <h3>Ownership Stack</h3>
                    <p>Beneficial holdings disclosed in the proxy</p>
                </div>
            </header>
            <ul class="stat-list">
                <li><span>Director Shares</span><strong>{{ "{:,.0f}".format(ownership_summary.director_shares) }}</strong></li>
                <li><span>Executive Shares</span><strong>{{ "{:,.0f}".format(ownership_summary.exec_shares) }}</strong></li>
                <li><span>Combined Control</span><strong>{{ "{:,.0f}".format(ownership_summary.total_shares) }}</strong></li>
                <li><span>Record Date</span><strong>{{ ownership_summary.as_of }}</strong></li>
            </ul>
        </div>

        <div class="team-card">
            <header class="team-card-header">
                <span class="icon">&#128200;</span>
                <div>
                    <h3>Market Signals</h3>
                    <p>Financial context & cap pressure</p>
                </div>
            </header>
            <ul class="stat-list">
                <li><span>Market Cap</span>
                    <strong>
                        {% if company.market_cap %}
                            ${{ "{:,.1f}".format(company.market_cap / 1_000_000_000) }}B
                        {% else %}
                            n/a
                        {% endif %}
                    </strong>
                </li>
                <li><span>Revenue</span>
                    <strong>
                        {% if company.revenue %}
                            ${{ "{:,.1f}".format(company.revenue / 1_000_000_000) }}B
                        {% else %}
                            n/a
                        {% endif %}
                    </strong>
                </li>
                <li><span>Exec % of Revenue</span>
                    <strong>
                        {% if cap_info.exec_percent_revenue %}
                            {{ "{:.2f}".format(cap_info.exec_percent_revenue) }}%
                        {% else %}
                            n/a
                        {% endif %}
                    </strong>
                </li>
                <li><span>Cap Budget</span><strong>${{ "{:,.0f}".format(cap_info.budget) }}</strong></li>
            </ul>
        </div>
    </section>

    <section class="metrics-grid">
        <div class="metric-card">
            <span class="metric-label">Revenue</span>
            <span class="metric-value">
                {% if company_summary.revenue %}
                    ${{ "{:,.0f}".format(company_summary.revenue) }}
                {% else %}
                    n/a
                {% endif %}
            </span>
            <span class="metric-context muted-small">Reported for fiscal year end {{ company.fiscal_year_end.strftime('%Y-%m-%d') }}</span>
        </div>
        <div class="metric-card">
            <span class="metric-label">Exec Payroll / Revenue</span>
            <span class="metric-value">
                {% if company_summary.exec_to_revenue_pct is not none %}
                    {{ "{:.2f}".format(company_summary.exec_to_revenue_pct) }}%
                {% else %}
                    n/a
                {% endif %}
            </span>
            <span class="metric-context muted-small">Executive spend relative to company revenue</span>
        </div>
        <div class="metric-card">
            <span class="metric-label">Total Payroll / Revenue</span>
            <span class="metric-value">
                {% if company_summary.total_to_revenue_pct is not none %}
                    {{ "{:.2f}".format(company_summary.total_to_revenue_pct) }}%
                {% else %}
                    n/a
                {% endif %}
            </span>
            <span class="metric-context muted-small">Executives + directors vs. revenue</span>
        </div>
        <div class="metric-card">
            <span class="metric-label">Revenue per Exec</span>
            <span class="metric-value">
                {% if company_summary.revenue_per_exec %}
                    ${{ "{:,.0f}".format(company_summary.revenue_per_exec) }}
                {% else %}
                    n/a
                {% endif %}
            </span>
            <span class="metric-context muted-small">{{ company_summary.exec_count }} named execs</span>
        </div>
        <div class="metric-card">
            <span class="metric-label">Avg Exec Compensation</span>
            <span class="metric-value">${{ "{:,.0f}".format(company_summary.comp_per_exec or 0) }}</span>
            <span class="metric-context muted-small">Mean total compensation</span>
        </div>
        <div class="metric-card">
            <span class="metric-label">Market Cap / Total Pay</span>
            <span class="metric-value">
                {% if company_summary.market_cap_to_pay %}
                    {{ "{:,.1f}".format(company_summary.market_cap_to_pay) }}Ã—
                {% else %}
                    n/a
                {% endif %}
            </span>
            <span class="metric-context muted-small">How many times payroll fits into market cap</span>
        </div>
    </section>

    <section class="insights-grid">
        <div class="team-card chart-card">
            <header class="team-card-header">
                <span class="icon">&#128202;</span>
                <div>
                    <h3>Payroll Mix</h3>
                    <p>Executive vs. board spend for {{ selected_year }}</p>
                </div>
            </header>
            <div class="chart-shell chart-shell--compact">
                <div id="compMixChart" class="radial-chart"></div>
            </div>
            <div class="chart-footnote">
                <span class="muted-small">Exec Payroll</span>
                <strong>${{ "{:,.0f}".format(company_summary.exec_total) }}</strong>
                <span class="muted-small">Director Payroll</span>
                <strong>${{ "{:,.0f}".format(company_summary.director_total) }}</strong>
            </div>
        </div>

        <div class="team-card chart-card">
            <header class="team-card-header">
                <span class="icon">&#128100;</span>
                <div>
                    <h3>Insider Ownership</h3>
                    <p>Executive vs. board voting power</p>
                </div>
            </header>
        <div class="chart-shell chart-shell--compact">
            <div id="ownershipMixChart" class="radial-chart"></div>
        </div>
        <div class="chart-footnote">
            <span class="muted-small">Total Insider Shares</span>
            <strong>{{ "{:,.0f}".format(ownership_summary.total_shares) }}</strong>
            <span class="muted-small">As of {{ ownership_summary.as_of }}</span>
        </div>
    </div>

        <div class="team-card chart-card">
            <header class="team-card-header">
                <span class="icon">&#128201;</span>
                <div>
                    <h3>Top Holders</h3>
                    <p>Largest disclosed insiders by shares</p>
                </div>
            </header>
            <div class="chart-shell chart-shell--compact">
                <canvas id="topOwnersChart"></canvas>
            </div>
        </div>
    </section>

    <section class="team-card full chart-card">
        <header class="team-card-header">
            <span class="icon">&#128200;</span>
            <div>
                <h3>Compensation Timeline</h3>
                <p>Exec + board outlay compared to budget across filings</p>
            </div>
        </header>
        <div class="chart-shell">
            <div id="compTimelineChart" class="timeline-chart"></div>
        </div>
        <p class="muted-small" style="margin-top: -0.5rem;">
            Filled area is total compensation; solid lines reflect exec/director splits, dashed line is the reported cap budget.
        </p>
    </section>

    {% if ownership_rows %}
    <section class="team-card full">
        <header class="team-card-header">
            <span class="icon">&#128462;</span>
            <div>
                <h3>Beneficial Ownership Ledger</h3>
                <p>Directors and executives with disclosed holdings</p>
            </div>
        </header>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Holder</th>
                        <th>Role</th>
                        <th>Total Shares</th>
                        <th>Sole Voting</th>
                        <th>Shared / 60 days</th>
                        <th>% of Class</th>
                        <th>As of</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in ownership_rows %}
                    <tr>
                        <td>{{ record.holder_name }}</td>
                        <td>{{ record.role }}</td>
                        <td class="salary-amount">{{ "{:,.0f}".format(record.total_shares) }}</td>
                        <td>{{ "{:,.0f}".format(record.sole_voting_power or 0) }}</td>
                        <td>{{ "{:,.0f}".format(record.shared_voting_power or 0) }}</td>
                        <td>
                            {% if record.percent_of_class %}
                                {{ "{:.3f}".format(record.percent_of_class) }}%
                            {% else %}
                                n/a
                            {% endif %}
                        </td>
                        <td>{{ record.as_of_date }}</td>
                        <td>{{ record.notes or 'n/a' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}

    <section class="team-card full chart-card">
        <header class="team-card-header">
            <span class="icon">&#128200;</span>
            <div>
                <h3>Executive Compensation Breakdown</h3>
                <p>Total compensation by named executive officer</p>
            </div>
        </header>
        <div class="chart-shell">
            <canvas id="compensationChart"></canvas>
        </div>
    </section>

    <!-- C-Suite Roster -->
    {% if c_suite %}
    <div class="roster-section">
        <div class="position-header">
            &#127919; C-Suite Executives ({{ c_suite|length }})
        </div>
        <table>
            <thead>
                <tr>
                    <th>Executive</th>
                    <th>Position</th>
                    <th>Age/Exp</th>
                    <th>Contract</th>
                    <th>Base Salary</th>
                    <th>Bonus</th>
                    <th>Stock Awards</th>
                    <th>Signing Bonus</th>
                    <th>Total Comp</th>
                    <th>Cap Hit %</th>
                </tr>
            </thead>
            <tbody>
                {% for exec in c_suite %}
                <tr>
                    <td>
                        <a href="{{ url_for('person_detail', person_id=exec.person_id) }}">
                            <strong>{{ exec.name }}</strong>
                        </a>
                    </td>
                    <td>{{ exec.title }}</td>
                    <td>
                        <small class="muted-small">
                            {{ exec.age or 'n/a' }}y &#8226; {{ exec.experience or 'n/a' }}y exp
                        </small>
                    </td>
                    <td>
                        <small class="muted-small">
                            {{ exec.contract_years }} years
                        </small>
                    </td>
                    <td class="salary-amount">${{ "{:,.0f}".format(exec.base_salary) }}</td>
                    <td class="salary-amount">${{ "{:,.0f}".format(exec.bonus) }}</td>
                    <td class="cap-hit">${{ "{:,.0f}".format(exec.stock_awards) }}</td>
                    <td class="salary-amount">
                        {% if exec.signing_bonus > 0 %}
                            ${{ "{:,.0f}".format(exec.signing_bonus) }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="salary-amount"><strong>${{ "{:,.0f}".format(exec.total_compensation) }}</strong></td>
                    <td class="cap-hit">{{ "{:.1f}".format(exec.cap_hit_pct) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Board Members -->
    {% if board_members %}
    <div class="roster-section">
        <div class="position-header" style="background: linear-gradient(90deg, #3b82f6, #1d4ed8);">
            &#127974; Board of Directors ({{ board_members|length }})
        </div>
        <table>
            <thead>
                <tr>
                    <th>Board Member</th>
                    <th>Position</th>
                    <th>Age/Exp</th>
                    <th>Contract</th>
                    <th>Cash Fees</th>
                    <th>Stock Awards</th>
                    <th>Other</th>
                    <th>Total Comp</th>
                </tr>
            </thead>
            <tbody>
                {% for member in board_members %}
                <tr>
                    <td>
                        <a href="{{ url_for('person_detail', person_id=member.person_id) }}">
                            <strong>{{ member.name }}</strong>
                        </a>
                    </td>
                    <td>{{ member.title }}</td>
                    <td>
                        <small class="muted-small">
                            {{ member.age or 'n/a' }}y &#8226; {{ member.experience or 'n/a' }}y exp
                        </small>
                    </td>
                    <td>
                        <small class="muted-small">
                            {{ member.contract_years }} years
                        </small>
                    </td>
                    <td class="salary-amount">${{ "{:,.0f}".format(member.base_salary) }}</td>
                    <td class="cap-hit">${{ "{:,.0f}".format(member.stock_awards) }}</td>
                    <td class="cap-hit">${{ "{:,.0f}".format(member.signing_bonus) }}</td>
                    <td class="salary-amount"><strong>${{ "{:,.0f}".format(member.total_compensation) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if director_comp_summary %}
    <div class="team-card" style="margin-top: 2rem;">
        <h3 class="warning-title" style="margin-top: 0;">&#127974; Board Compensation Snapshot</h3>
        <div class="cap-stats">
            <div class="stat-item">
                <div class="stat-label">Directors Covered</div>
                <div class="stat-value">{{ director_comp_summary.members }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Avg Cash Retainer</div>
                <div class="stat-value">${{ "{:,.0f}".format(director_comp_summary.avg_cash) }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Avg Stock Award</div>
                <div class="stat-value">${{ "{:,.0f}".format(director_comp_summary.avg_stock) }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Avg Total Comp</div>
                <div class="stat-value">${{ "{:,.0f}".format(director_comp_summary.avg_total) }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if director_policies %}
    <div class="team-card" style="margin-top: 2rem;">
        <h3 class="accent-title" style="margin-top: 0;">&#128466; Director Compensation Policy</h3>
        <ul style="margin: 0; padding-left: 1.2rem; color: #cbd5f5;">
            {% for policy in director_policies %}
            <li style="margin-bottom: 0.5rem;">
                <strong>{{ policy.component }}</strong>
                {% if policy.amount_usd %}
                    n/a ${{ "{:,.0f}".format(policy.amount_usd) }} {{ policy.unit or '' }}
                {% endif %}
                {% if policy.notes %}
                    <br><small class="muted-small">{{ policy.notes }}</small>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <script>
        // Chart.js implementation for compensation visualization
        const execBarLabels = {{ chart_labels|safe }};
        const execBarValues = {{ chart_data|safe }};
        const compMixData = {{ comp_mix_chart|tojson }};
        const ownershipMixData = {{ ownership_mix_chart|tojson }};
        const topOwnerChartData = {{ top_owner_chart|tojson }};
        const timeSeriesData = {{ compensation_time_series|tojson }};

        const compensationCanvas = document.getElementById('compensationChart');
        if (compensationCanvas) {
            new Chart(compensationCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: execBarLabels,
                    datasets: [{
                        label: 'Total Compensation (USD)',
                        data: execBarValues,
                        backgroundColor: 'rgba(244, 63, 94, 0.78)',
                        borderColor: 'rgba(244, 63, 94, 1)',
                        borderWidth: 1.5,
                        borderRadius: 5,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#e2e8f0',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return 'Total Compensation: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        const formatCurrency = (value) => {
            if (!value) {
                return '$0';
            }
            const abs = Math.abs(value);
            if (abs >= 1_000_000_000) {
                return '$' + (value / 1_000_000_000).toFixed(1) + 'B';
            }
            if (abs >= 1_000_000) {
                return '$' + (value / 1_000_000).toFixed(1) + 'M';
            }
            return '$' + value.toLocaleString();
        };

        const formatCurrencyShort = (value) => {
            if (!value) return '$0';
            const abs = Math.abs(value);
            if (abs >= 1_000_000_000) {
                return '$' + (value / 1_000_000_000).toFixed(1) + 'B';
            }
            return '$' + (value / 1_000_000).toFixed(abs >= 100_000_000 ? 0 : 1) + 'M';
        };

        const renderRadialChart = (containerId, dataset, options = {}) => {
            const target = document.getElementById(containerId);
            if (!target) return;
            target.innerHTML = '';

            const values = dataset?.values || [];
            if (!values.some(value => Number(value) > 0)) {
                target.innerHTML = '<p class="chart-empty muted-small">Not enough data to display.</p>';
                return;
            }

            const size = options.size || 240;
            const radius = size / 2;
            const thickness = options.thickness || 32;
            const colors = options.colors || ['#f43f5e', '#2563eb', '#0ea5e9'];

            const slices = (dataset.labels || []).map((label, index) => ({
                label,
                value: Number(values[index] || 0),
                detail: dataset.shares ? dataset.shares[index] : undefined,
                index
            }));

            const total = d3.sum(slices, slice => slice.value);
            const svg = d3.select(target)
                .append('svg')
                .attr('viewBox', `0 0 ${size} ${size}`)
                .attr('preserveAspectRatio', 'xMidYMid meet');

            const group = svg.append('g')
                .attr('transform', `translate(${radius}, ${radius})`);

            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius - thickness)
                .outerRadius(radius);

            group.selectAll('path')
                .data(pie(slices))
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', (_, index) => colors[index % colors.length])
                .attr('stroke', '#0b0906')
                .attr('stroke-width', 2)
                .attr('opacity', 0.95);

            const centerText = options.centerText
                ? options.centerText(slices, total)
                : {
                    primary: total ? `${Math.round((slices[0].value / total) * 100)}%` : '0%',
                    secondary: slices[0]?.label || '',
                    tertiary: formatCurrency(slices[0]?.value || 0)
                };

            const centerLines = [
                { value: centerText.primary, className: 'radial-center-value' },
                { value: centerText.secondary, className: 'radial-center-label' },
                { value: centerText.tertiary, className: 'radial-center-subtle' },
            ].filter(line => line.value);

            const centerGroup = group.append('g').attr('class', 'radial-center');
            const lineSpacing = 18;
            const startY = -((centerLines.length - 1) * lineSpacing) / 2;
            centerLines.forEach((line, idx) => {
                centerGroup.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('class', line.className)
                    .attr('y', startY + idx * lineSpacing)
                    .text(line.value);
            });

            const legendFormatter = options.legendFormatter || ((slice, totalValue) => {
                const pct = totalValue ? (slice.value / totalValue) * 100 : 0;
                return `${slice.label}: ${pct.toFixed(1)}% â€¢ ${formatCurrency(slice.value)}`;
            });

            const legend = d3.select(target)
                .append('div')
                .attr('class', 'radial-legend');

            const legendItems = legend.selectAll('div')
                .data(slices)
                .enter()
                .append('div')
                .attr('class', 'radial-legend-item');

            legendItems.append('span')
                .attr('class', 'radial-legend-swatch')
                .style('background', (_, idx) => colors[idx % colors.length]);

            legendItems.append('span')
                .attr('class', 'radial-legend-text')
                .text(slice => legendFormatter(slice, total));
        };

        const renderTimeSeries = (containerId, dataset) => {
            const target = document.getElementById(containerId);
            if (!target) return;
            target.innerHTML = '';

            if (!dataset?.labels || !dataset.labels.length) {
                target.innerHTML = '<p class="chart-empty muted-small">Waiting on historical filings.</p>';
                return;
            }

            const points = dataset.labels.map((label, index) => ({
                year: label,
                exec: Number(dataset.exec_totals?.[index] || 0),
                director: Number(dataset.director_totals?.[index] || 0),
                combined: Number(dataset.combined_totals?.[index] || 0),
                budget: Number(dataset.budget?.[index] || 0)
            }));

            const viewWidth = 760;
            const viewHeight = 360;
            const margin = { top: 20, right: 24, bottom: 44, left: 70 };
            const width = viewWidth - margin.left - margin.right;
            const height = viewHeight - margin.top - margin.bottom;

            const svg = d3.select(target)
                .append('svg')
                .attr('viewBox', `0 0 ${viewWidth} ${viewHeight}`)
                .attr('preserveAspectRatio', 'xMidYMid meet');

            const plot = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);

            const x = d3.scalePoint()
                .domain(points.map(point => point.year))
                .range([0, width])
                .padding(0.5);

            const yMax = d3.max(points, point => Math.max(point.combined, point.budget)) || 0;
            const y = d3.scaleLinear()
                .domain([0, yMax ? yMax * 1.1 : 1])
                .range([height, 0]);

            plot.append('g')
                .attr('class', 'timeline-grid')
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''))
                .call(g => g.select('.domain').remove());

            plot.append('g')
                .attr('class', 'timeline-axis')
                .call(d3.axisLeft(y).tickFormat(value => formatCurrencyShort(value)));

            plot.append('g')
                .attr('class', 'timeline-axis')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            const area = d3.area()
                .x(point => x(point.year))
                .y0(y(0))
                .y1(point => y(point.combined))
                .curve(d3.curveMonotoneX);

            plot.append('path')
                .datum(points)
                .attr('fill', 'rgba(250, 204, 21, 0.12)')
                .attr('stroke', 'none')
                .attr('d', area);

            const lineGenerator = (accessor) => d3.line()
                .x(point => x(point.year))
                .y(point => y(accessor(point)))
                .curve(d3.curveMonotoneX);

            plot.append('path')
                .datum(points)
                .attr('fill', 'none')
                .attr('stroke', '#fbbf24')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '6,4')
                .attr('opacity', 0.9)
                .attr('d', lineGenerator(point => point.budget));

            plot.append('path')
                .datum(points)
                .attr('fill', 'none')
                .attr('stroke', '#f43f5e')
                .attr('stroke-width', 2.2)
                .attr('d', lineGenerator(point => point.exec));

            plot.append('path')
                .datum(points)
                .attr('fill', 'none')
                .attr('stroke', '#38bdf8')
                .attr('stroke-width', 2.2)
                .attr('d', lineGenerator(point => point.director));

            const execAccessor = (point) => point.exec;
            const directorAccessor = (point) => point.director;
            const budgetAccessor = (point) => point.budget;

            const dotMaker = (accessor, color, label) => {
                plot.selectAll(`.timeline-dot-${label}`)
                    .data(points)
                    .enter()
                    .append('circle')
                    .attr('class', `timeline-dot timeline-dot-${label}`)
                    .attr('cx', point => x(point.year))
                    .attr('cy', point => y(accessor(point)))
                    .attr('r', 3)
                    .attr('fill', color)
                    .append('title')
                    .text(point => `${point.year}: ${formatCurrency(accessor(point))}`);
            };

            dotMaker(execAccessor, '#f43f5e', 'exec');
            dotMaker(directorAccessor, '#38bdf8', 'director');
            dotMaker(budgetAccessor, '#fbbf24', 'budget');

            const legend = d3.select(target)
                .append('div')
                .attr('class', 'timeline-legend');

            const legendItems = [
                { label: 'Exec Payroll', color: '#f43f5e' },
                { label: 'Director Payroll', color: '#38bdf8' },
                { label: 'Cap Budget', color: '#fbbf24', dashed: true }
            ];

            const legendBlocks = legend.selectAll('div')
                .data(legendItems)
                .enter()
                .append('div')
                .attr('class', 'timeline-legend-item');

            legendBlocks.append('span')
                .attr('class', 'timeline-legend-swatch')
                .style('background', item => item.dashed ? 'transparent' : item.color)
                .style('border-color', item => item.dashed ? item.color : 'transparent')
                .style('border-style', item => item.dashed ? 'dashed' : 'solid');

            legendBlocks.append('span')
                .text(item => item.label);
        };

        if (compMixData?.values?.some(value => Number(value) > 0)) {
            renderRadialChart('compMixChart', compMixData, {
                colors: ['#f43f5e', '#2563eb'],
                ariaLabel: 'Executive versus board payroll split',
                centerText: (slices, total) => {
                    const primary = slices[0];
                    const pct = total ? Math.round((primary.value / total) * 100) : 0;
                    return {
                        primary: `${pct}%`,
                        secondary: primary.label,
                        tertiary: formatCurrency(primary.value)
                    };
                }
            });
        } else {
            renderRadialChart('compMixChart', { labels: [], values: [] });
        }

        if (ownershipMixData?.values?.some(value => Number(value) > 0)) {
            renderRadialChart('ownershipMixChart', ownershipMixData, {
                colors: ['#0ea5e9', '#fbbf24'],
                ariaLabel: 'Executive versus board insider ownership',
                centerText: () => {
                    const pct = ownershipMixData.values?.[0] ?? 0;
                    const shares = ownershipMixData.shares?.[0];
                    return {
                        primary: `${pct.toFixed(1)}%`,
                        secondary: ownershipMixData.labels?.[0] || 'Exec insiders',
                        tertiary: shares ? `${shares.toLocaleString()} sh` : ''
                    };
                },
                legendFormatter: (slice) => {
                    const shareCount = slice.detail;
                    const shareText = shareCount ? ` â€¢ ${shareCount.toLocaleString()} sh` : '';
                    return `${slice.label}: ${slice.value.toFixed(1)}%${shareText}`;
                }
            });
        } else {
            renderRadialChart('ownershipMixChart', { labels: [], values: [] });
        }

        renderTimeSeries('compTimelineChart', timeSeriesData);

        const topOwnersCanvas = document.getElementById('topOwnersChart');
        if (topOwnersCanvas && topOwnerChartData.labels.length) {
            new Chart(topOwnersCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: topOwnerChartData.labels,
                    datasets: [{
                        label: 'Total Shares',
                        data: topOwnerChartData.shares,
                        backgroundColor: 'rgba(16, 185, 129, 0.75)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const shares = ctx.parsed.x.toLocaleString();
                                    const pct = topOwnerChartData.percent_of_class[ctx.dataIndex];
                                    const pctText = pct ? ` (${pct.toFixed(2)}%)` : '';
                                    return `Shares: ${shares}${pctText}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#94a3b8',
                                callback: (value) => value.toLocaleString()
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    </script>
{% endblock %}
